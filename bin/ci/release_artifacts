#!/usr/bin/env bash
set -o errexit
set -o pipefail

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"

# shellcheck disable=SC1090
source "${DIR}/common.sh"

# shellcheck disable=SC2154
[ -f "${tfplan}" ] || exit -1

if [ -n "${REMOTE_STATE_BACKEND}" ] && [ -n "${BUILD_ID}" ]; then
  mkdir -p "${HOME}/.aws"
  artifacts="artifacts/${TF_WORKSPACE}/${BUILD_ID}"
  terraform show -json | aws s3 cp --quiet - s3://"${REMOTE_STATE_BACKEND}"/"${artifacts}"/state.json
  aws s3 cp --quiet "${tfplan:?}" s3://"${REMOTE_STATE_BACKEND}"/"${artifacts}"/"${tfplan}" --content-type "binary/octet-stream"
  #aws s3 cp --quiet "*.auto.tfvars" s3://"${REMOTE_STATE_BACKEND}"/"${artifacts}"/
#else 
#  terraform show -json | python3 -m json.tool 
fi
